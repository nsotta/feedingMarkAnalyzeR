#' Load series of ImageJ output of leaf area measurement (`.xls` files) and make them into a single data.table.
#' @name makeLeafAreaTable
#' @param xls_dir Character.Path to directory that contains `.xls` files of leaf area measurement for each frame.
#' @param name_pat Character. Regular expression for finding files of leaf area measurement for each frame.
#' @param area_convertion_rate Numeric. Conversion rate for leaf area. Default = 1.
#' @param frame_interval Numeric. Time intervals between frames. Default = 1.
#' @param roi_info_file Character. Path to ROI information file(csv, "roi" column with sequential number from 1, and extra columns that characterize each ROI). Set `NULL` if ROI information is not provided at this stage.
#' @return Long-format data.table of frame, time, ROI, and leaf area.
#' @importFrom gsubfn strapplyc
#' @importFrom utils read.table
#' @import data.table stringr
#' @export
makeLeafAreaTable <- function(xls_dir,
                          name_pat = "^[0-9]*",
                          area_convertion_rate = 1,
                          frame_interval = 1,
                          roi_info_file = NULL){
  # Get list of xls files
  file_list <- list.files(pattern="xls",
                          path = xls_dir)

  # Vector of individual names
  ind_vec <- unique(unlist(strapplyc(file_list,name_pat)))

  # Create output table
  out <- data.frame()

  # To check whether all the files have the same ROI number.
  total_roi_in_first_frame <- NULL

  # Load measurement results of each individual and merge them into a table
  for (i.index in ind_vec) {
    i.file <- paste0(i.index,".xls")
    # cat(file.path(xls_dir,i.file))
    x <- read.table(file.path(xls_dir,i.file))

    if (is.null(total_roi_in_first_frame)) {
      total_roi_in_first_frame <- nrow(x)
    } else {
      if (total_roi_in_first_frame != nrow(x)) {
        cat("Total ROI number is different from the first frame, skipping: ",i.file,"\n")
        next
      }
    }

    # Rename ROI, 1 from the left
    x$roi <- rownames(x)
    x <- x[,c("roi","IntDen")]
    x$filename <- i.index

    out <- rbind(out,x)
  }

  # Convert unit if needed. White:0 Black 255. Make it 0/1.
  out$LeafArea <- out$IntDen * area_convertion_rate / 255

  # Get frame number from the file names
  out$frame <- as.numeric(str_remove(
    str_remove(out$filename,"feeding_track_"),
    "_deltamask"))

  out$time <- out$frame * frame_interval

  if (!is.null(roi_info_file)) {
    roi_info <- fread(roi_info_file)
    out <- merge(out,
                 roi_info,
                 by = "roi") %>% data.table()
  }

  out <- out[order(roi,frame)]

  return(out)
}




#' Calculate differences in leaf area between t and t+1 from `leaf_area` table.
#' @name getDeltaLeafArea
#' @param leaf_area data.table generated by `makeLeafAreaTable`.
#' @importFrom tidyr pivot_wider pivot_longer %>%
#' @import data.table
#' @return data.table of time differences in leaf area.
#' @export
makeDeltaLeafAreaTable <- function(leaf_area){

  roi_info <- leaf_area[!duplicated(roi),-c('LeafArea','time','filename','frame' )]

  data_rel <- alignStart(leaf_area)
  leaf_area_diff <- data_rel[,.(time,decrease,roi)] %>%
    pivot_wider(names_from = "roi",
                values_from = "decrease") %>%
    data.table
  leaf_area_diff <- leaf_area_diff[order(time)]

  tmp_time <- leaf_area_diff[,time]
  leaf_area_diff <- apply(leaf_area_diff[,-1],2,diff) %>%
    data.table

  leaf_area_diff$time <- tmp_time[1:(length(tmp_time)-1)]

  leaf_area_diff <- leaf_area_diff %>%
    pivot_longer(cols = -time,
                 names_to = "roi",
                 values_to = "delta")

  leaf_area_diff <- merge(leaf_area_diff,
                     roi_info,
                     by = "roi") %>%
    data.table()

  leaf_area_diff[,delta := delta * -1]

  return(leaf_area_diff)
}




#' Align leaf area decrease curve at t=0
#' @name alignStart
#' @param leaf_area data.table generated by `makeLeafAreaTable`.
#' @import data.table
#' @return data.table similar to the input `leaf_area` but LeafArea starts from 0 at frame = 1.
#' @export
alignStart <- function(leaf_area){
  data_rel <- data.table(leaf_area)
  data_t1 <- data_rel[frame == 1,.(roi,  t1 = LeafArea)]
  data_rel <- merge(data_rel,
                    data_t1,
                    by = "roi",
                    all.x = T)
  data_rel[,decrease := LeafArea - t1]
  return(data_rel)
}




#' Detect peaks and return position information for single ROI.
#' @name getPeaks
#' @param leaf_area_diff_sub A part (single ROI) of data.table generated by `makeDeltaLeafAreaTable`.
#' @param thr_start Numeric. Threshold value of area diff to detect start of the peak.
#' @param thr_end Numeric. Threshold value of area diff to detect start of the peak.
#' @import data.table
#' @importFrom tibble rowid_to_column
#' @return `data.table` with 4 column: start,end,area,interval. Returns NULL when no peak is detected.
#' @export
getPeaks <- function(leaf_area_diff_sub,
                     thr_start = 0.2,
                     thr_end = 0.05){

  # Status    0: baseline    1: peak
  status = 0
  peaks = data.table()
  peak_tmp = data.table()

  in_diff <- leaf_area_diff_sub[order(time),][,delta]
  in_time <- leaf_area_diff_sub[order(time),][,time]

  for (i.pos in 2:length(in_diff)) {

    if (status == 0) {
      if (in_diff[i.pos] > thr_start) {
        peak_tmp$start <- in_time[i.pos]
        peak_tmp$area <- in_diff[i.pos]
        status <- 1
      }

    } else if (status == 1) {  # Within peak

      peak_tmp$area <-  peak_tmp$area + in_diff[i.pos]

      if (in_diff[i.pos] < thr_end){
        peak_tmp$end <- in_time[i.pos]
        peak_tmp[,width := end - start + 1]
        peaks <- rbind(peaks,
                       peak_tmp)
        status <- 0
      }
    }
  }

  if (nrow(peaks) == 0) {
    peaks = NULL
  } else {

    if (nrow(peaks) > 1) {
      peaks$interval <- peaks$start - c(0,(peaks$end)[1:(length(peaks$end)-1)])
    } else {
      peaks$interval <- NA
    }

    peaks$rate <-  peaks$area/peaks$width
    peaks <- peaks %>%
      tibble::rowid_to_column("no")
  }

  return(peaks)
}


#' Detect peaks and return position information for all ROIs.
#' @name getPeaksAllRoi
#' @param leaf_area_diff data.table generated by `makeDeltaLeafAreaTable`.
#' @param thr_start Numeric. Threshold value of area diff to detect start of the peak.
#' @param thr_end Numeric. Threshold value of area diff to detect start of the peak.
#' @import data.table
#' @export
getPeaksAllRoi <- function(leaf_area_diff,
                           thr_start = 0.2,
                           thr_end = 0.05){

  roi_info <- leaf_area_diff[!duplicated(roi),-c('delta','time')]

  dt_list <- split(leaf_area_diff,
                   f = leaf_area_diff$roi)
  peaks_list <- lapply(dt_list,
                       getPeaks,
                       thr_start = thr_start,
                       thr_end = thr_end)

  peaks <- rbindlist(peaks_list,
                        idcol = "roi")
  peaks <- merge(peaks,
                    roi_info,
                    by = "roi") %>%
    data.table()

  return(peaks)
}


